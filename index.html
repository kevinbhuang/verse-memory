<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESV Verse Memory Vault</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --gold: #f1c40f; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--light); padding: 20px; color: #333; line-height: 1.6; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .stats-bar { display: flex; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 15px 25px; border-radius: 10px; margin-bottom: 25px; }
        .input-section, .quiz-section { background: #fff; border: 2px solid #edf2f7; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        textarea { width: 100%; height: 80px; margin: 10px 0; padding: 12px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 1rem; resize: none; }
        button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        button:hover { background: #2980b9; transform: translateY(-1px); }
        .verse-list { margin-top: 20px; max-height: 300px; overflow-y: auto; }
        .verse-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #edf2f7; }
        .verse-item:last-child { border-bottom: none; }
        #display-area { font-size: 1.4rem; font-weight: 500; text-align: center; margin: 30px 0; min-height: 80px; color: var(--primary); }
        .letter-box { width: 100%; font-size: 1.8rem; text-align: center; border: 2px solid var(--accent); border-radius: 8px; padding: 10px; text-transform: uppercase; letter-spacing: 5px; }
        .hidden { display: none; }
        .badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="stats-bar">
        <span>ðŸ”¥ Streak: <strong id="streak-val">0</strong> days</span>
        <span class="badge">Awards: <span id="awards-list">None</span></span>
    </div>

    <div id="home-view">
        <div class="input-section">
            <h3>Add New Verses</h3>
            <p style="font-size: 0.85rem; color: #666;">Enter references (e.g., <i>Philippians 4:13</i>) one per line:</p>
            <textarea id="ref-list" placeholder="John 1:1&#10;Ephesians 2:8-9"></textarea>
            <button onclick="fetchVerses()" id="fetch-btn">Import ESV Verses</button>
        </div>

        <div class="input-section">
            <h3>Verse List</h3>
            <div id="verse-list-container" class="verse-list"></div>
        </div>
    </div>

    <div id="quiz-view" class="quiz-section hidden">
        <h2 id="current-ref" style="text-align:center; color: var(--accent);"></h2>
        <div id="display-area"></div>
        <div id="interaction-area"></div>
        <div style="text-align:center; margin-top: 20px;">
            <button style="background: #95a5a6;" onclick="exitQuiz()">Exit</button>
        </div>
    </div>
</div>

<script>
    const API_TOKEN = 'ffa5803ef5933fd9ddf379532b748f1b45e9db69';
    let verses = JSON.parse(localStorage.getItem('verses')) || [];
    let stats = JSON.parse(localStorage.getItem('memStats')) || { streak: 0, lastDate: null, awards: [] };
    let currentVerse = null;

    async function fetchVerses() {
        const input = document.getElementById('ref-list');
        const refs = input.value.split('\n').filter(r => r.trim() !== '');
        if (!refs.length) return;

        const btn = document.getElementById('fetch-btn');
        btn.innerText = "Fetching...";
        btn.disabled = true;

        for (let ref of refs) {
            try {
                const response = await fetch(`https://api.esv.org/v3/passage/text/?q=${encodeURIComponent(ref)}&include-headings=false&include-footnotes=false&include-verse-numbers=false&include-short-copyright=false`, {
                    headers: { 'Authorization': `Token ${API_TOKEN}` }
                });
                const data = await response.json();
                if (data.passages?.length) {
                    verses.push({ ref: data.canonical, text: data.passages[0].trim() });
                }
            } catch (e) { console.error("Error:", e); }
        }

        localStorage.setItem('verses', JSON.stringify(verses));
        input.value = '';
        btn.innerText = "Import ESV Verses";
        btn.disabled = false;
        renderList();
    }

    function renderList() {
        const container = document.getElementById('verse-list-container');
        container.innerHTML = verses.length ? '' : '<p style="color:#999">No verses added yet.</p>';
        verses.forEach((v, i) => {
            const div = document.createElement('div');
            div.className = 'verse-item';
            div.innerHTML = `<strong>${v.ref}</strong> <button onclick="startPractice(${i})">Memorize</button>`;
            container.appendChild(div);
        });
    }

    function startPractice(index) {
        currentVerse = verses[index];
        document.getElementById('home-view').classList.add('hidden');
        document.getElementById('quiz-view').classList.remove('hidden');
        document.getElementById('current-ref').innerText = currentVerse.ref;
        initFirstLetterMode();
    }

    function initFirstLetterMode() {
        const display = document.getElementById('display-area');
        const interaction = document.getElementById('interaction-area');
        
        // Split text and get target first letters
        const words = currentVerse.text.split(/\s+/).filter(w => w.length > 0);
        const targets = words.map(w => w.replace(/[^a-zA-Z]/g, '')[0].toUpperCase());
        
        display.innerHTML = `<span style="color:#95a5a6">Type the first letter of each word...</span>`;
        interaction.innerHTML = `<input type="text" class="letter-box" id="typer" autocomplete="off">`;
        
        const typer = document.getElementById('typer');
        typer.focus();

        typer.oninput = () => {
            const inputVal = typer.value.toUpperCase();
            let correctCount = 0;
            
            // Check letters typed so far
            for (let i = 0; i < inputVal.length; i++) {
                if (inputVal[i] === targets[i]) {
                    correctCount++;
                } else {
                    typer.value = inputVal.substring(0, i);
                    return;
                }
            }

            // Show progress
            display.innerText = words.slice(0, correctCount).join(' ');

            if (correctCount === targets.length) {
                display.style.color = 'var(--success)';
                typer.disabled = true;
                handleWin();
            }
        };
    }

    function handleWin() {
        const today = new Date().toDateString();
        const yesterday = new Date(Date.now() - 86400000).toDateString();

        if (stats.lastDate !== today) {
            stats.streak = (stats.lastDate === yesterday) ? stats.streak + 1 : 1;
            stats.lastDate = today;
        }

        // Award System
        const newAwards = [];
        if (stats.streak >= 3) newAwards.push('ðŸ”¥');
        if (stats.streak >= 7) newAwards.push('ðŸ›¡ï¸');
        if (verses.length >= 10) newAwards.push('ðŸ“œ');
        stats.awards = [...new Set([...stats.awards, ...newAwards])];

        localStorage.setItem('memStats', JSON.stringify(stats));
        updateStatsUI();
    }

    function updateStatsUI() {
        document.getElementById('streak-val').innerText = stats.streak;
        document.getElementById('awards-list').innerText = stats.awards.length ? stats.awards.join(' ') : 'None';
    }

    function exitQuiz() {
        document.getElementById('quiz-view').classList.add('hidden');
        document.getElementById('home-view').classList.remove('hidden');
    }

    renderList();
    updateStatsUI();
</script>
</body>
</html>
